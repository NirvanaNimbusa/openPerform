<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">

    <title>Open Perform by Kinetech Arts</title>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="libs/bootstrap-3.3.4/css/bootstrap.min.css">
    
    <!-- font awesome -->
    <link rel="stylesheet" href="libs/font-awesome/css/font-awesome.min.css">
    
    <!-- Bootstrap datePicker-->
    <link href="libs/bootstrap-3.3.4/plugins/datePicker/css/bootstrap-datepicker.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" href="libs/dc.min.css">
</head>
<body>
  <div id="App"></div>
  <script src="libs/jquery-1.10.0.min.js"></script>
  
  <script src="libs/bootstrap.min.js"></script>
  
  <script src="libs/bootstrap-3.3.4/plugins/datePicker/js/bootstrap-datepicker.min.js"></script>
  <script src="libs/bootstrap-3.3.4/plugins/datePicker/locales/bootstrap-datepicker.en-GB.min.js"></script>

   <script type="x-shader/x-vertex" id="vertexshader">
    #define M_PI 3.1415926535897932384626433832795
    #define MaxImpacts 100
    #define IMPACT_CYCLES 4.0
    #define EARTH_RADIUS 205.0

    uniform float time;
    uniform int numImpacts;
    uniform vec4 impacts[ MaxImpacts ];

    attribute float size;
    attribute float alpha;
    attribute vec3 customColor;
    attribute vec3 ringColor;

    varying vec3 vColor;
    varying vec3 rColor;

    varying float vAlpha;
 
    float degToRad( float deg ){
      return deg/180.0 * M_PI;
    }

    // from [lat, lon, mag] in degree to [lat, lon, mag] in radiant
    vec3 getRadCoord(vec3 pos){
      return vec3( degToRad(pos.x), degToRad(pos.y - 90.0), pos.z);
    }

    // from radiant coordinate to 3D model coordinate
    vec3 project(vec3 coord){
      vec3 pos;

      float lat = coord.x;
      float lon = coord.y;

      // float dir = 250.0 + 50.0*sin(time);
      // float dir = 300.0 + 5.0 * float(numImpacts);
      float dir = EARTH_RADIUS + coord.z;
      pos.x = dir*cos(lat)*sin(lon);
      pos.y = dir*sin(lat);
      pos.z = dir*cos(lat)*cos(lon);

      return pos;
    }

    vec3 calImpact(vec3 pos, vec4 impact){
      float omega = 6.0;
      float velocity = 10.0;
      float magnitude = impact[2];

      vec3 center = impact.xyz;
      float r = distance(center, pos) + 0.1;
      vec3 offset = vec3(0,0,0);

      float dTime = time - impact[3];
      float phase =  omega*(r / velocity - dTime);

      float fitAngle = IMPACT_CYCLES * M_PI;

      if( phase < 0.0 && phase > -2.0* fitAngle){
        float envelop = (fitAngle - abs(phase + fitAngle)) / fitAngle;
        float displacement = envelop * envelop * magnitude * 20.0 * sin(phase) / (1.0+dTime);
        vec3 direction = pos - center;
        offset += 0.5 * displacement * direction / r;
        offset.z = displacement;
      }
      // offset.x = 300.0*sin(0.1*time);
      return offset;
    }

    void main() {
      vColor = customColor;
      rColor = ringColor;
      vAlpha = alpha;
      vec3 pos;
      vec3 center = vec3(0.0,0.0, 0.0); //ripple
      vec3 posLatLon = vec3(position.xy, 0); //can't reassign attibute

      for( int i = 0; i< MaxImpacts; i++){
        if(i<numImpacts){
          // posLatLon += calImpact(position, vec4(0,0,0, 0));
          posLatLon += calImpact(position, impacts[i]);
        }
      }

      vec3 radCoord = getRadCoord(posLatLon);

      vec3 pos3d = project(radCoord);      

      vec4 mvPosition = modelViewMatrix * vec4( pos3d, 1.0 );
      gl_PointSize = size * ( 300.0 / -mvPosition.z );
      gl_Position = projectionMatrix * mvPosition;
    }
  </script>

  <script type="x-shader/x-fragment" id="fragmentshader">
    uniform vec3 color;
    uniform sampler2D texture;
    varying vec3 vColor;
    varying vec3 rColor;
    varying float vAlpha;
    void main() {
        // gl_FragColor = vec4( color * vColor, 1.0 );
        gl_FragColor = vec4(gl_PointCoord.s, gl_PointCoord.t, 0, vAlpha);
        float len = length(gl_PointCoord- vec2(0.5, 0.5));
        if(len < 0.5){
          gl_FragColor = vec4(vColor, vAlpha);
        }else{
          gl_FragColor.a = 0.0;
        }
        // gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );
        if ( gl_FragColor.a < ALPHATEST ) discard;
      }
    </script>
    <script src="libs/stats.min.js"></script>
    <script src="js/Index.js"></script>
</body>
</html>
